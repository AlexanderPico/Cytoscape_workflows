<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />


<meta name="author" content="Ruth Isserlin" />

<meta name="date" content="2017-12-13" />

<title>Enrichment Map Analysis Pipeline</title>

<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/paper.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="site_libs/jqueryui-1.11.4/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/font-awesome-4.5.0/css/font-awesome.min.css" rel="stylesheet" />


<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #0000ff; } /* Keyword */
code > span.ch { color: #008080; } /* Char */
code > span.st { color: #008080; } /* String */
code > span.co { color: #008000; } /* Comment */
code > span.ot { color: #ff4000; } /* Other */
code > span.al { color: #ff0000; } /* Alert */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #008000; font-weight: bold; } /* Warning */
code > span.cn { } /* Constant */
code > span.sc { color: #008080; } /* SpecialChar */
code > span.vs { color: #008080; } /* VerbatimString */
code > span.ss { color: #008080; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { } /* Variable */
code > span.cf { color: #0000ff; } /* ControlFlow */
code > span.op { } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #ff4000; } /* Preprocessor */
code > span.do { color: #008000; } /* Documentation */
code > span.an { color: #008000; } /* Annotation */
code > span.cv { color: #008000; } /* CommentVar */
code > span.at { } /* Attribute */
code > span.in { color: #008000; } /* Information */
</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>


<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>


</head>

<body>

<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
  height: auto;
}
.tabbed-pane {
  padding-top: 12px;
}
button.code-folding-btn:focus {
  outline: none;
}
</style>


<style type="text/css">
/* padding for bootstrap navbar */
body {
  padding-top: 64px;
  padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar)  */
.section h1 {
  padding-top: 69px;
  margin-top: -69px;
}

.section h2 {
  padding-top: 69px;
  margin-top: -69px;
}
.section h3 {
  padding-top: 69px;
  margin-top: -69px;
}
.section h4 {
  padding-top: 69px;
  margin-top: -69px;
}
.section h5 {
  padding-top: 69px;
  margin-top: -69px;
}
.section h6 {
  padding-top: 69px;
  margin-top: -69px;
}
</style>

<script>
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.parent().addClass('active');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');
});
</script>


<div class="container-fluid main-container">

<!-- tabsets -->
<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});
</script>

<!-- code folding -->




<script>
$(document).ready(function ()  {

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_').toLowerCase();
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = false;
    options.smoothScroll = false;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}


.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
  padding-left: 25px;
  text-indent: 0;
}

.tocify .list-group-item {
  border-radius: 0px;
}

.tocify-subheader {
  display: inline;
}
.tocify-subheader .tocify-item {
  font-size: 0.95em;
}

</style>

<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row-fluid">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="navbar navbar-inverse  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">Enrichment Map Protocol</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="https://baderlab.github.io/Cytoscape_workflows/">
    <span class="fa fa-home"></span>
     
    Home
  </a>
</li>
<li>
  <a href="https://www.biorxiv.org/content/early/2017/12/12/232835">
    <span class="fa fa-newspaper-o"></span>
     
    bioRxiv paper
  </a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fa fa-list"></span>
     
    Table of Contents
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li class="dropdown-header">Supplementary Protocols</li>
    <li>
      <a href="Download_TCGA_data.html">Download TCGA Data</a>
    </li>
    <li>
      <a href="supplemental_protocol1_rnaseq.html">Process RNASeq data</a>
    </li>
    <li>
      <a href="supplemental_protocol2_microarray.html">Process Microarray data</a>
    </li>
    <li class="divider"></li>
    <li class="dropdown-header">Protocol 2</li>
    <li>
      <a href="Protocol2_createEM.html">Create Enrichment Map</a>
    </li>
  </ul>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div class="fluid-row" id="header">



<h1 class="title toc-ignore">Enrichment Map Analysis Pipeline</h1>
<h4 class="author"><em>Ruth Isserlin</em></h4>
<h4 class="date"><em>2017-12-13</em></h4>

</div>


<div id="materials" class="section level1">
<h1><span class="header-section-number">1</span> Materials</h1>
<div id="equipment" class="section level2">
<h2><span class="header-section-number">1.1</span> Equipment</h2>
<div id="hardware-requirements" class="section level3">
<h3><span class="header-section-number">1.1.1</span> Hardware requirements:</h3>
<ul>
<li>A recent personal computer with Internet access and at least 8GB of RAM.</li>
</ul>
</div>
<div id="software-requirements" class="section level3">
<h3><span class="header-section-number">1.1.2</span> Software requirements:</h3>
<ul>
<li>A contemporary web browser (e.g. Chrome, Firefox), for pathway enrichment analysis with g:Profiler (Protocol 1A).</li>
<li>Java Standard Edition. Java is required to run GSEA and Cytoscape. It is available at <a href="http://java.oracle.com" class="uri">http://java.oracle.com</a>. Version 8 or higher is requiredrecommended, but Java 7 will function.</li>
<li>GSEA desktop application for pathway enrichment analysis protocol 1B. Download the latest version of GSEA from <a href="http://www.broadinstitute.org/gsea/downloads.jsp" class="uri">http://www.broadinstitute.org/gsea/downloads.jsp</a>. We recommend the javaGSEA desktop application. Free registration is required.</li>
<li>Cytoscape desktop application is required for Enrichment Map visualization. The latest version of Cytoscape can be downloaded at <a href="http://www.cytoscape.org" class="uri">http://www.cytoscape.org</a>.</li>
<li>The following Cytoscape apps are installed within Cytoscape. Go to Apps  App manager (i.e., open the Apps menu and select the item “App manager”).</li>
<li>Enrichment Map, version 3.0 or higher,</li>
<li>Clustermaker2, version 0.9.5 or higher,</li>
<li>WordCloud, version 3.1.0 or higher,</li>
<li>AutoAnnotate, version 1.2.0 or higher</li>
</ul>
</div>
</div>
</div>
<div id="create-enrichment-map---automaticallly-from-r-using-cyrest" class="section level1">
<h1><span class="header-section-number">2</span> Create Enrichment Map - Automaticallly from R using cyRest</h1>
<div id="load-in-required-libraries" class="section level2">
<h2><span class="header-section-number">2.1</span> Load in required libraries</h2>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#install required R and bioconductor packages</span>
<span class="kw">tryCatch</span>(<span class="dt">expr =</span> { <span class="kw">library</span>(<span class="st">&quot;RCurl&quot;</span>)}, 
         <span class="dt">error =</span> function(e) {  <span class="kw">install.packages</span>(<span class="st">&quot;RCurl&quot;</span>)}, 
         <span class="dt">finally =</span> <span class="kw">library</span>(<span class="st">&quot;RCurl&quot;</span>))</code></pre></div>
<pre><code>## Loading required package: bitops</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#use library</span>
<span class="kw">tryCatch</span>(<span class="dt">expr =</span> { <span class="kw">library</span>(<span class="st">&quot;limma&quot;</span>)}, 
         <span class="dt">error =</span> function(e) { <span class="kw">source</span>(<span class="st">&quot;https://bioconductor.org/biocLite.R&quot;</span>)
           <span class="kw">biocLite</span>(<span class="st">&quot;limma&quot;</span>)}, 
         <span class="dt">finally =</span> <span class="kw">library</span>(<span class="st">&quot;limma&quot;</span>))</code></pre></div>
<pre><code>## Warning: package &#39;limma&#39; was built under R version 3.4.1</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">tryCatch</span>(<span class="dt">expr =</span> { <span class="kw">library</span>(<span class="st">&quot;Biobase&quot;</span>)}, 
         <span class="dt">error =</span> function(e) { <span class="kw">source</span>(<span class="st">&quot;https://bioconductor.org/biocLite.R&quot;</span>)
           <span class="kw">biocLite</span>(<span class="st">&quot;Biobase&quot;</span>)}, 
         <span class="dt">finally =</span> <span class="kw">library</span>(<span class="st">&quot;Biobase&quot;</span>))</code></pre></div>
<pre><code>## Loading required package: BiocGenerics</code></pre>
<pre><code>## Loading required package: parallel</code></pre>
<pre><code>## 
## Attaching package: &#39;BiocGenerics&#39;</code></pre>
<pre><code>## The following objects are masked from &#39;package:parallel&#39;:
## 
##     clusterApply, clusterApplyLB, clusterCall, clusterEvalQ,
##     clusterExport, clusterMap, parApply, parCapply, parLapply,
##     parLapplyLB, parRapply, parSapply, parSapplyLB</code></pre>
<pre><code>## The following object is masked from &#39;package:limma&#39;:
## 
##     plotMA</code></pre>
<pre><code>## The following objects are masked from &#39;package:stats&#39;:
## 
##     IQR, mad, sd, var, xtabs</code></pre>
<pre><code>## The following objects are masked from &#39;package:base&#39;:
## 
##     anyDuplicated, append, as.data.frame, cbind, colMeans,
##     colnames, colSums, do.call, duplicated, eval, evalq, Filter,
##     Find, get, grep, grepl, intersect, is.unsorted, lapply,
##     lengths, Map, mapply, match, mget, order, paste, pmax,
##     pmax.int, pmin, pmin.int, Position, rank, rbind, Reduce,
##     rowMeans, rownames, rowSums, sapply, setdiff, sort, table,
##     tapply, union, unique, unsplit, which, which.max, which.min</code></pre>
<pre><code>## Welcome to Bioconductor
## 
##     Vignettes contain introductory material; view with
##     &#39;browseVignettes()&#39;. To cite Bioconductor, see
##     &#39;citation(&quot;Biobase&quot;)&#39;, and for packages &#39;citation(&quot;pkgname&quot;)&#39;.</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">tryCatch</span>(<span class="dt">expr =</span> { <span class="kw">library</span>(<span class="st">&quot;ggplot2&quot;</span>)}, 
         <span class="dt">error =</span> function(e) { <span class="kw">install.packages</span>(<span class="st">&quot;ggplot2&quot;</span>)}, 
         <span class="dt">finally =</span> <span class="kw">library</span>(<span class="st">&quot;ggplot2&quot;</span>))

<span class="co">#For creating json and communicating with cytoscape</span>
<span class="kw">tryCatch</span>(<span class="dt">expr =</span> { <span class="kw">library</span>(<span class="st">&quot;httr&quot;</span>)}, 
         <span class="dt">error =</span> function(e) { <span class="kw">install.packages</span>(<span class="st">&quot;httr&quot;</span>)}, 
         <span class="dt">finally =</span> <span class="kw">library</span>(<span class="st">&quot;httr&quot;</span>))</code></pre></div>
<pre><code>## Warning: package &#39;httr&#39; was built under R version 3.4.1</code></pre>
<pre><code>## 
## Attaching package: &#39;httr&#39;</code></pre>
<pre><code>## The following object is masked from &#39;package:Biobase&#39;:
## 
##     content</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">tryCatch</span>(<span class="dt">expr =</span> { <span class="kw">library</span>(<span class="st">&quot;RJSONIO&quot;</span>)}, 
         <span class="dt">error =</span> function(e) { <span class="kw">install.packages</span>(<span class="st">&quot;RJSONIO&quot;</span>)}, 
         <span class="dt">finally =</span> <span class="kw">library</span>(<span class="st">&quot;RJSONIO&quot;</span>))</code></pre></div>
<hr />
</div>
<div id="configurable-parameters" class="section level2">
<h2><span class="header-section-number">2.2</span> Configurable Parameters</h2>
<p>In order to run GSEA automatically through the notebook you will need to download the gsea jar from <a href="http://software.broadinstitute.org/gsea/downloads.jsp">here</a>. Specify the exact path to the gsea jar below in order to automatically compute enrichments using GSEA.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#path to GSEA jar </span>
<span class="co"># In order to run GSEA automatically you need to speciry the path to the gsea jar file.</span>
gsea_jar &lt;-<span class="st"> &quot;./gsea-3.0.jar&quot;</span>

<span class="co">#Gsea takes a long time to run.  If you have already run GSEA manually or previously there is no need to re-run GSEA.  Make sure the </span>
<span class="co"># gsea results are in the current directory and the notebook will be able to find them and use them.</span>
run_gsea =<span class="st"> </span><span class="ot">FALSE</span>

<span class="co">#navigate to the directory where you put the downloaded protocol files.</span>
working_dir &lt;-<span class="st"> </span><span class="kw">paste</span>(<span class="st">&quot;./data&quot;</span>,<span class="dt">sep=</span><span class="st">&quot;/&quot;</span>)

<span class="co"># leave blank if you want the notebook to discover the gsea directory for itself</span>
<span class="co">#gsea_directory = paste(working_dir,&quot;Mesen_vs_Immuno.GseaPreranked.1497635459262&quot;,sep=&quot;/&quot;) </span>
gsea_directory =<span class="st"> &quot;&quot;</span>

analysis_name &lt;-<span class="st"> &quot;Mesen_vs_Immuno&quot;</span>
rnk_file &lt;-<span class="st"> &quot;Supplementary_Table2_MesenvsImmuno_RNASeq_ranks.rnk&quot;</span>
expression_file &lt;-<span class="st"> &quot;Supplementary_Table6_TCGA_OV_RNAseq_expression.txt&quot;</span>
classes_file &lt;-<span class="st"> &quot;Supplementary_Table9_TCGA_OV_RNAseq_classes.cls&quot;</span></code></pre></div>
</div>
<div id="download-the-latest-pathway-definition-file" class="section level2">
<h2><span class="header-section-number">2.3</span> Download the latest pathway definition file</h2>
<p>Only Human, Mouse and Rat gene set files are currently available on the baderlab downloads site. If you are working with a species other than human (and it is either rat or mouse) change the gmt_url below to correct species. Check <a href="http://download.baderlab.org/EM_Genesets/current_release/">here</a> to see all available species.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">gmt_url =<span class="st"> &quot;http://download.baderlab.org/EM_Genesets/current_release/Human/symbol/&quot;</span>

<span class="co">#list all the files on the server</span>
filenames =<span class="st"> </span><span class="kw">getURL</span>(gmt_url)
tc =<span class="st"> </span><span class="kw">textConnection</span>(filenames)
contents =<span class="st"> </span><span class="kw">readLines</span>(tc)
<span class="kw">close</span>(tc)</code></pre></div>
<pre><code>## Found more than one class &quot;textConnection&quot; in cache; using the first, from namespace &#39;BiocGenerics&#39;</code></pre>
<pre><code>## Also defined by &#39;RJSONIO&#39;</code></pre>
<pre><code>## Found more than one class &quot;textConnection&quot; in cache; using the first, from namespace &#39;BiocGenerics&#39;</code></pre>
<pre><code>## Also defined by &#39;RJSONIO&#39;</code></pre>
<pre><code>## Found more than one class &quot;textConnection&quot; in cache; using the first, from namespace &#39;BiocGenerics&#39;</code></pre>
<pre><code>## Also defined by &#39;RJSONIO&#39;</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#get the gmt that has all the pathways and does not include terms inferred from electronic annotations(IEA)</span>
<span class="co">#start with gmt file that has pathways only</span>
rx =<span class="st"> </span><span class="kw">gregexpr</span>(<span class="st">&quot;(?&lt;=&lt;a href=</span><span class="ch">\&quot;</span><span class="st">)(.*.GOBP_AllPathways_no_GO_iea.*.)(.gmt)(?=</span><span class="ch">\&quot;</span><span class="st">&gt;)&quot;</span>,
  contents, <span class="dt">perl =</span> <span class="ot">TRUE</span>)
gmt_file =<span class="st"> </span><span class="kw">unlist</span>(<span class="kw">regmatches</span>(contents, rx))

dest_gmt_file &lt;-<span class="st"> </span><span class="kw">paste</span>(working_dir,<span class="kw">paste</span>(<span class="st">&quot;Supplementary_Table3_&quot;</span>,gmt_file,<span class="dt">sep=</span><span class="st">&quot;&quot;</span>) ,<span class="dt">sep=</span><span class="st">&quot;/&quot;</span>)

<span class="kw">download.file</span>(
    <span class="kw">paste</span>(gmt_url,gmt_file,<span class="dt">sep=</span><span class="st">&quot;&quot;</span>),
    <span class="dt">destfile=</span>dest_gmt_file
)</code></pre></div>
<hr />
</div>
<div id="run-gsea" class="section level2">
<h2><span class="header-section-number">2.4</span> Run GSEA</h2>
<p>(GSEA)[<a href="http://software.broadinstitute.org/gsea/index.jsp" class="uri">http://software.broadinstitute.org/gsea/index.jsp</a>] is a stand alone java program with many customizable options. It can be easily run through its integrated user interface. To make this a seemless pipeline we can run GSEA from the command line with a set of options. Any of the supplied options can be customized and there are many additional options that can be specified. For more details see (here)[<a href="http://software.broadinstitute.org/gsea/doc/GSEAUserGuideTEXT.htm#_Running_GSEA_from" class="uri">http://software.broadinstitute.org/gsea/doc/GSEAUserGuideTEXT.htm#_Running_GSEA_from</a>]</p>
<p>In the below command the following options have been specified:</p>
<ul>
<li>rnk - path to the rank file</li>
<li>gmx - path to the gene set definition (gmt) file</li>
<li>collapse - true/false indicates whether the expression/rnk file needs to be collapsed from probes to gene symbols</li>
<li>nperm - number of permutations</li>
<li>permute - permute gene sets or phentoypes. For GSEA preranked you can only permute genesets.</li>
<li>scoring_scheme -</li>
<li>rpt_label - name of the directory with output</li>
<li>num - number of results to plot output file for</li>
<li>rnd_seed - random seed to use</li>
<li>set_max - maximum size for individual gene sets. In GSEA interface this is set to 500 but we prefer to use a more stringent setting of 200.</li>
<li>set_min - minimum size for individual gene sets</li>
<li>zip_report - true/false to zip output directory</li>
<li>out - directory where to place the result directory.</li>
<li>gui - true/false. When running GSEA from the commandline this needs to be false.</li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">if(run_gsea){
  command &lt;-<span class="st"> </span><span class="kw">paste</span>(<span class="st">&quot;java  -Xmx1G -cp&quot;</span>,gsea_jar,  <span class="st">&quot;xtools.gsea.GseaPreranked -gmx&quot;</span>, dest_gmt_file, <span class="st">&quot;-rnk&quot;</span> ,<span class="kw">paste</span>(working_dir,rnk_file,<span class="dt">sep=</span><span class="st">&quot;/&quot;</span>), <span class="st">&quot;-collapse false -nperm 1000 -permute gene_set -scoring_scheme weighted -rpt_label &quot;</span>,analysis_name,<span class="st">&quot;  -num 100 -plot_top_x 20 -rnd_seed 12345  -set_max 200 -set_min 15 -zip_report false -out&quot;</span> ,working_dir, <span class="st">&quot;-gui false &gt; gsea_output.txt&quot;</span>,<span class="dt">sep=</span><span class="st">&quot; &quot;</span>)
  <span class="kw">system</span>(command)
}</code></pre></div>
</div>
<div id="get-the-name-of-the-gsea-output-directory" class="section level2">
<h2><span class="header-section-number">2.5</span> Get the name of the GSEA output directory</h2>
<p>Although GSEA allows you to specify the name of the output directory and the destination folder it add additional words and numbers to the folder name. Some are predictable and some are automatically generated. Get all the GSEA results directories found in the current directory. If there are multiple GSEA results folders each will be used to create an enrichment map.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">if(gsea_directory ==<span class="st"> &quot;&quot;</span>){
  gsea_directories &lt;-<span class="st"> </span><span class="kw">list.files</span>(<span class="dt">path =</span> working_dir, <span class="dt">pattern =</span> <span class="st">&quot;</span><span class="ch">\\</span><span class="st">.GseaPreranked&quot;</span>)

  <span class="co">#get the details on the files</span>
  details =<span class="st"> </span><span class="kw">file.info</span>(<span class="kw">paste</span>(<span class="kw">getwd</span>(),working_dir,gsea_directories,<span class="dt">sep=</span><span class="st">&quot;/&quot;</span>))
  <span class="co">#order according to newest to oldest</span>
  details =<span class="st"> </span>details[<span class="kw">with</span>(details, <span class="kw">order</span>(<span class="kw">as.POSIXct</span>(mtime),<span class="dt">decreasing =</span> <span class="ot">TRUE</span>)), ]

  <span class="co">#use the newest file:</span>
  gsea_output_dir &lt;-<span class="st"> </span><span class="kw">row.names</span>(details)[<span class="dv">1</span>]
} else {
  gsea_output_dir &lt;-<span class="st"> </span>gsea_directory
}</code></pre></div>
<hr />
</div>
<div id="launch-cytoscape" class="section level2">
<h2><span class="header-section-number">2.6</span> Launch Cytoscape</h2>
<p>Create EM through Cyrest interface - make sure you open cytoscape with a -R 1234 (to enable rest functionality) and allow R to talk directly to cytoscape.</p>
<p>Launch Cytoscape (by default cytoscape will automatically enable rest so as long as cytoscape 3.3 or higher is open R should be able to communicate with it)</p>
</div>
<div id="set-up-connection-from-r-to-cytoscape" class="section level2">
<h2><span class="header-section-number">2.7</span> Set up connection from R to cytoscape</h2>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Basic settings</span>
port.number =<span class="st"> </span><span class="dv">1234</span>
base.url =<span class="st"> </span><span class="kw">paste</span>(<span class="st">&quot;http://localhost:&quot;</span>, <span class="kw">toString</span>(port.number), <span class="st">&quot;/v1&quot;</span>, <span class="dt">sep=</span><span class="st">&quot;&quot;</span>)

<span class="co">#print(base.url)</span>

version.url =<span class="st"> </span><span class="kw">paste</span>(base.url, <span class="st">&quot;version&quot;</span>, <span class="dt">sep=</span><span class="st">&quot;/&quot;</span>)
cytoscape.open =<span class="st"> </span><span class="ot">TRUE</span>

<span class="kw">tryCatch</span>(<span class="dt">expr =</span> { <span class="kw">GET</span>(version.url)}, 
         <span class="dt">error =</span> function(e) { <span class="kw">return</span> (<span class="dt">cytoscape.open =</span> <span class="ot">FALSE</span>)}, <span class="dt">finally =</span>function(r){ <span class="kw">return</span>(<span class="dt">cytoscape.open =</span> <span class="ot">TRUE</span>)})</code></pre></div>
<pre><code>## Response [http://localhost:1234/v1/version]
##   Date: 2017-12-13 11:36
##   Status: 200
##   Content-Type: application/json
##   Size: 46 B</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">if(!cytoscape.open){
  <span class="co">#try and launch cytoscape</span>
 <span class="kw">print</span>(<span class="st">&quot;Cytoscape is not open.  Please launch cytoscape.&quot;</span>)
} else{
  cytoscape.version =<span class="st">  </span><span class="kw">GET</span>(version.url)
  cy.version =<span class="st"> </span><span class="kw">fromJSON</span>(<span class="kw">rawToChar</span>(cytoscape.version$content))
  <span class="kw">print</span>(cy.version)
  
}</code></pre></div>
<pre><code>##       apiVersion cytoscapeVersion 
##             &quot;v1&quot;          &quot;3.5.1&quot;</code></pre>
<hr />
</div>
<div id="create-an-enrichment-map" class="section level2">
<h2><span class="header-section-number">2.8</span> Create an Enrichment map</h2>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#detach(&quot;package:EasycyRest&quot;, unload = TRUE)</span>

<span class="co">#use easy cyRest library to communicate with cytoscape.</span>
<span class="kw">tryCatch</span>(<span class="dt">expr =</span> { <span class="kw">library</span>(devtools)}, 
         <span class="dt">error =</span> function(e) { <span class="kw">install.packages</span>(<span class="st">&quot;devtools&quot;</span>)}, <span class="dt">finally =</span> <span class="kw">library</span>(devtools))</code></pre></div>
<pre><code>## Warning: package &#39;devtools&#39; was built under R version 3.4.1</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">tryCatch</span>(<span class="dt">expr =</span> { <span class="kw">library</span>(r2cytoscape)}, 
          <span class="dt">error =</span> function(e) { <span class="kw">install_github</span>(<span class="st">&#39;cytoscape/cytoscape-automation/for-scripters/R/r2cytoscape&#39;</span>)}, <span class="dt">finally =</span> <span class="kw">library</span>(r2cytoscape))</code></pre></div>
<pre><code>## Loading required package: XML</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">tryCatch</span>(<span class="dt">expr =</span> { <span class="kw">library</span>(EasycyRest)}, 
          <span class="dt">error =</span> function(e) { <span class="kw">install_github</span>(<span class="st">&#39;BaderLab/Easycyrest/EasycyRest&#39;</span>)}, <span class="dt">finally =</span> <span class="kw">library</span>(EasycyRest))</code></pre></div>
<pre><code>## 
## Attaching package: &#39;EasycyRest&#39;</code></pre>
<pre><code>## The following objects are masked from &#39;package:r2cytoscape&#39;:
## 
##     createNetwork, createStyle</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#defined threshold for GSEA enrichments (need to be strings for cyrest call)</span>
pvalue_gsea_threshold &lt;-<span class="st"> &quot;1.0&quot;</span>
qvalue_gsea_threshold &lt;-<span class="st"> &quot;0.01&quot;</span>

similarity_threshold &lt;-<span class="st"> &quot;0.375&quot;</span>
similarity_metric =<span class="st"> &quot;COMBINED&quot;</span>

GSEA_results &lt;-<span class="st"> </span><span class="kw">paste</span>(gsea_output_dir,<span class="dt">sep=</span><span class="st">&quot;/&quot;</span>)
current_rank_filename =<span class="st"> </span><span class="kw">paste</span>(working_dir,rnk_file,<span class="dt">sep=</span><span class="st">&quot;/&quot;</span>)
cur_model_name &lt;-<span class="st"> </span>analysis_name

gsea_results_path &lt;-<span class="st"> </span><span class="kw">paste</span>(GSEA_results,<span class="st">&quot;edb&quot;</span>,<span class="dt">sep=</span><span class="st">&quot;/&quot;</span>)
gsea_results_filename &lt;-<span class="st"> </span><span class="kw">paste</span>(gsea_results_path,<span class="st">&quot;results.edb&quot;</span>,<span class="dt">sep=</span><span class="st">&quot;/&quot;</span>)

<span class="co">#although there is a gmt file in the gsea edb results directory it have been filtered to contain only genes represented in </span>
<span class="co"># the expression set.  If you use this fltered file you will get different pathway connectivity depending on the dataset being</span>
<span class="co"># used.  We recommend using original gmt file used for the gsea analysis and not the filtered one in the results directory.</span>
gmt_gsea_file &lt;-<span class="st"> </span><span class="kw">paste</span>(<span class="kw">getwd</span>(),dest_gmt_file,<span class="dt">sep=</span><span class="st">&quot;/&quot;</span>)
gsea_ranks_file &lt;-<span class="st"> </span><span class="kw">paste</span>(gsea_results_path,<span class="kw">list.files</span>(gsea_results_path,<span class="dt">pattern=</span><span class="st">&quot;.rnk&quot;</span>),<span class="dt">sep=</span><span class="st">&quot;/&quot;</span>)


#######################################
<span class="co">#create EM pvalue &lt; 0.01 and qvalue &lt; 0.01</span>
#######################################
current_network_name &lt;-<span class="st"> </span><span class="kw">paste</span>(cur_model_name,pvalue_gsea_threshold,qvalue_gsea_threshold,<span class="dt">sep=</span><span class="st">&quot;_&quot;</span>)

em_command =<span class="st"> </span><span class="kw">paste</span>(<span class="st">&#39;enrichmentmap build analysisType=&quot;gsea&quot; gmtFile=&#39;</span>,gmt_gsea_file,
                   <span class="st">&#39;pvalue=&#39;</span>,pvalue_gsea_threshold, <span class="st">&#39;qvalue=&#39;</span>,qvalue_gsea_threshold,
                   <span class="st">&#39;similaritycutoff=&#39;</span>,similarity_threshold,
                   <span class="st">&#39;coefficients=&#39;</span>,similarity_metric,<span class="st">&#39;ranksDataset1=&#39;</span>, 
                   gsea_ranks_file,<span class="st">&#39;enrichmentsDataset1=&#39;</span>,gsea_results_filename, <span class="st">&#39;filterByExpressions=false&#39;</span>,
                   <span class="st">&#39;expressionDataset1=&#39;</span>,<span class="kw">paste</span>(<span class="kw">getwd</span>(),working_dir,expression_file,<span class="dt">sep=</span><span class="st">&quot;/&quot;</span>),
                   <span class="dt">sep=</span><span class="st">&quot; &quot;</span>)

<span class="co">#enrichment map command will return the suid of newly created network.</span>
response &lt;-<span class="st"> </span><span class="kw">commandRun</span>(em_command)

current_network_suid &lt;-<span class="st"> </span><span class="dv">0</span>
<span class="co">#enrichment map command will return the suid of newly created network unless it Failed.  If it failed it will contain the word failed</span>
if(<span class="kw">grepl</span>(<span class="dt">pattern=</span><span class="st">&quot;Failed&quot;</span>, response)){
  <span class="kw">paste</span>(response)
} else {
  current_network_suid &lt;-<span class="st"> </span>response
}</code></pre></div>
<pre><code>## [1] &quot;Failed: The Geneset: MITOTIC ANAPHASE%REACTOME DATABASE ID RELEASE 61%68882 is not found in the GMT file.&quot;</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">response &lt;-<span class="st"> </span><span class="kw">renameNetwork</span>(<span class="dt">new.name =</span> current_network_name, <span class="dt">network =</span> current_network_suid, base.url)</code></pre></div>
</div>
<div id="get-a-screen-shot-of-the-initial-network." class="section level2">
<h2><span class="header-section-number">2.9</span> Get a screen shot of the initial network.</h2>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">output_network_file &lt;-<span class="st"> </span><span class="kw">paste</span>(<span class="kw">getwd</span>(),<span class="st">&quot;initial_screenshot_network.png&quot;</span>,<span class="dt">sep=</span><span class="st">&quot;/&quot;</span>)

url_png &lt;-<span class="st"> </span><span class="kw">paste</span>(base.url,<span class="st">&quot;networks&quot;</span>,current_network_suid,<span class="st">&quot;views/first.png&quot;</span>, <span class="dt">sep=</span><span class="st">&quot;/&quot;</span>)
response &lt;-<span class="st"> </span><span class="kw">GET</span>(<span class="dt">url=</span>url_png)
<span class="kw">writeBin</span>(response$content, output_network_file)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">htmltools::<span class="kw">img</span>(<span class="dt">src =</span> knitr::<span class="kw">image_uri</span>(output_network_file), 
               <span class="dt">alt =</span> <span class="st">&#39;Initial Enrichment Map&#39;</span>, 
               <span class="dt">style =</span> <span class="st">&#39;margin:0px auto;display:block&#39;</span>)</code></pre></div>
<img src="data:image/png;base64,PGh0bWw+CjxoZWFkPgo8bWV0YSBodHRwLWVxdWl2PSJDb250ZW50LVR5cGUiIGNvbnRlbnQ9InRleHQvaHRtbDsgY2hhcnNldD1JU08tODg1OS0xIi8+Cjx0aXRsZT5FcnJvciA0MDQgTm90IEZvdW5kPC90aXRsZT4KPC9oZWFkPgo8Ym9keT48aDI+SFRUUCBFUlJPUiA0MDQ8L2gyPgo8cD5Qcm9ibGVtIGFjY2Vzc2luZyAvdjEvbmV0d29ya3MvMC92aWV3cy9maXJzdC5wbmcuIFJlYXNvbjoKPHByZT4gICAgTm90IEZvdW5kPC9wcmU+PC9wPjxociAvPjxpPjxzbWFsbD5Qb3dlcmVkIGJ5IEpldHR5Oi8vPC9zbWFsbD48L2k+PGJyLz4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKPGJyLz4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKPGJyLz4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKPGJyLz4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKPGJyLz4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKPGJyLz4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKPGJyLz4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKPGJyLz4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKPGJyLz4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKPGJyLz4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKPGJyLz4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKPGJyLz4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKPGJyLz4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKPGJyLz4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKPGJyLz4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKPGJyLz4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKPGJyLz4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKPGJyLz4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKPGJyLz4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKPGJyLz4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKCjwvYm9keT4KPC9odG1sPgo=" alt="Initial Enrichment Map" style="margin:0px auto;display:block"/>
</div>
</div>



</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
